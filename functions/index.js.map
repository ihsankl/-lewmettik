{"version":3,"file":"index.js","names":["functions","require","Sentry","init","dsn","process","env","SENTRY_DSN","app","APP_PORT","NODE_ENV","TEST_APP_PORT","PORT","APP_HOST","pathToSwaggerUi","absolutePath","set","locals","title","APP_NAME","version","APP_VERSION","use","Handlers","requestHandler","stream","logStream","bodyParser","json","errorHandler","routes","swaggerIndexContent","fs","readFileSync","toString","replace","get","req","res","send","redirect","express","static","genericErrorHandler","methodNotAllowed","listen","logger","info","on","err","error","captureException","exit","exports","runWith","memory","timeoutSeconds","https","onRequest"],"sources":["../src/index.js"],"sourcesContent":["import './env';\nimport './db';\n\nimport fs from 'fs';\nimport cors from 'cors';\n// import path from 'path';\nimport helmet from 'helmet';\nimport morgan from 'morgan';\nimport express from 'express';\n// import favicon from 'serve-favicon';\nimport bodyParser from 'body-parser';\nimport compression from 'compression';\nimport * as Sentry from '@sentry/node';\n\nimport routes from './routes';\nimport json from './middlewares/json';\nimport logger, { logStream } from './utils/logger';\nimport * as errorHandler from './middlewares/errorHandler';\nconst functions = require('firebase-functions');\n\n// Initialize Sentry\n// https://docs.sentry.io/platforms/node/express/\nSentry.init({ dsn: process.env.SENTRY_DSN });\n\nconst app = express();\n\nconst APP_PORT =\n  (process.env.NODE_ENV === 'test' ? process.env.TEST_APP_PORT : process.env.APP_PORT) || process.env.PORT || '3000';\nconst APP_HOST = process.env.APP_HOST || '0.0.0.0';\n\nconst pathToSwaggerUi = require('swagger-ui-dist').absolutePath();\n\napp.set('port', APP_PORT);\napp.set('host', APP_HOST);\n\napp.locals.title = process.env.APP_NAME;\napp.locals.version = process.env.APP_VERSION;\n\n// This request handler must be the first middleware on the app\napp.use(Sentry.Handlers.requestHandler());\n\n// app.use(favicon(path.join(__dirname, '/../public', 'favicon.ico')));\napp.use(cors());\napp.use(helmet());\napp.use(compression());\napp.use(morgan('tiny', { stream: logStream }));\napp.use(bodyParser.json());\napp.use(errorHandler.bodyParser);\napp.use(json);\n\n// API Routes\napp.use('/api', routes);\n\n// Swagger UI\n// Workaround for changing the default URL in swagger.json\n// https://github.com/swagger-api/swagger-ui/issues/4624\nconst swaggerIndexContent = fs\n  .readFileSync(`${pathToSwaggerUi}/index.html`)\n  .toString()\n  .replace('https://petstore.swagger.io/v2/swagger.json', '/api/swagger.json');\n\napp.get('/api-docs/index.html', (req, res) => res.send(swaggerIndexContent));\napp.get('/api-docs', (req, res) => res.redirect('/api-docs/index.html'));\napp.use('/api-docs', express.static(pathToSwaggerUi));\n\n// This error handler must be before any other error middleware\napp.use(Sentry.Handlers.errorHandler());\n\n// Error Middleware\napp.use(errorHandler.genericErrorHandler);\napp.use(errorHandler.methodNotAllowed);\n\napp.listen(app.get('port'), app.get('host'), () => {\n  logger.info(`Server started at http://${app.get('host')}:${app.get('port')}/api`);\n});\n\n// Catch unhandled rejections\nprocess.on('unhandledRejection', (err) => {\n  logger.error('Unhandled rejection', err);\n\n  try {\n    Sentry.captureException(err);\n  } catch (err) {\n    logger.error('Sentry error', err);\n  } finally {\n    process.exit(1);\n  }\n});\n\n// Catch uncaught exceptions\nprocess.on('uncaughtException', (err) => {\n  logger.error('Uncaught exception', err);\n\n  try {\n    Sentry.captureException(err);\n  } catch (err) {\n    logger.error('Sentry error', err);\n  } finally {\n    process.exit(1);\n  }\n});\n\nexports.app = functions.runWith({\n  memory: '2GB',\n  timeoutSeconds: 540,\n}).https.onRequest(app); \n"],"mappings":";;AAAA;;AACA;;AAEA;;AACA;;AAEA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;;;;;;;AAZA;AAIA;AASA,MAAMA,SAAS,GAAGC,OAAO,CAAC,oBAAD,CAAzB,C,CAEA;AACA;;;AACAC,MAAM,CAACC,IAAP,CAAY;EAAEC,GAAG,EAAEC,OAAO,CAACC,GAAR,CAAYC;AAAnB,CAAZ;AAEA,MAAMC,GAAG,GAAG,uBAAZ;AAEA,MAAMC,QAAQ,GACZ,CAACJ,OAAO,CAACC,GAAR,CAAYI,QAAZ,KAAyB,MAAzB,GAAkCL,OAAO,CAACC,GAAR,CAAYK,aAA9C,GAA8DN,OAAO,CAACC,GAAR,CAAYG,QAA3E,KAAwFJ,OAAO,CAACC,GAAR,CAAYM,IAApG,IAA4G,MAD9G;AAEA,MAAMC,QAAQ,GAAGR,OAAO,CAACC,GAAR,CAAYO,QAAZ,IAAwB,SAAzC;;AAEA,MAAMC,eAAe,GAAGb,OAAO,CAAC,iBAAD,CAAP,CAA2Bc,YAA3B,EAAxB;;AAEAP,GAAG,CAACQ,GAAJ,CAAQ,MAAR,EAAgBP,QAAhB;AACAD,GAAG,CAACQ,GAAJ,CAAQ,MAAR,EAAgBH,QAAhB;AAEAL,GAAG,CAACS,MAAJ,CAAWC,KAAX,GAAmBb,OAAO,CAACC,GAAR,CAAYa,QAA/B;AACAX,GAAG,CAACS,MAAJ,CAAWG,OAAX,GAAqBf,OAAO,CAACC,GAAR,CAAYe,WAAjC,C,CAEA;;AACAb,GAAG,CAACc,GAAJ,CAAQpB,MAAM,CAACqB,QAAP,CAAgBC,cAAhB,EAAR,E,CAEA;;AACAhB,GAAG,CAACc,GAAJ,CAAQ,oBAAR;AACAd,GAAG,CAACc,GAAJ,CAAQ,sBAAR;AACAd,GAAG,CAACc,GAAJ,CAAQ,2BAAR;AACAd,GAAG,CAACc,GAAJ,CAAQ,qBAAO,MAAP,EAAe;EAAEG,MAAM,EAAEC;AAAV,CAAf,CAAR;AACAlB,GAAG,CAACc,GAAJ,CAAQK,oBAAWC,IAAX,EAAR;AACApB,GAAG,CAACc,GAAJ,CAAQO,YAAY,CAACF,UAArB;AACAnB,GAAG,CAACc,GAAJ,CAAQM,aAAR,E,CAEA;;AACApB,GAAG,CAACc,GAAJ,CAAQ,MAAR,EAAgBQ,eAAhB,E,CAEA;AACA;AACA;;AACA,MAAMC,mBAAmB,GAAGC,YACzBC,YADyB,CACX,GAAEnB,eAAgB,aADP,EAEzBoB,QAFyB,GAGzBC,OAHyB,CAGjB,6CAHiB,EAG8B,mBAH9B,CAA5B;;AAKA3B,GAAG,CAAC4B,GAAJ,CAAQ,sBAAR,EAAgC,CAACC,GAAD,EAAMC,GAAN,KAAcA,GAAG,CAACC,IAAJ,CAASR,mBAAT,CAA9C;AACAvB,GAAG,CAAC4B,GAAJ,CAAQ,WAAR,EAAqB,CAACC,GAAD,EAAMC,GAAN,KAAcA,GAAG,CAACE,QAAJ,CAAa,sBAAb,CAAnC;AACAhC,GAAG,CAACc,GAAJ,CAAQ,WAAR,EAAqBmB,iBAAQC,MAAR,CAAe5B,eAAf,CAArB,E,CAEA;;AACAN,GAAG,CAACc,GAAJ,CAAQpB,MAAM,CAACqB,QAAP,CAAgBM,YAAhB,EAAR,E,CAEA;;AACArB,GAAG,CAACc,GAAJ,CAAQO,YAAY,CAACc,mBAArB;AACAnC,GAAG,CAACc,GAAJ,CAAQO,YAAY,CAACe,gBAArB;AAEApC,GAAG,CAACqC,MAAJ,CAAWrC,GAAG,CAAC4B,GAAJ,CAAQ,MAAR,CAAX,EAA4B5B,GAAG,CAAC4B,GAAJ,CAAQ,MAAR,CAA5B,EAA6C,MAAM;EACjDU,gBAAOC,IAAP,CAAa,4BAA2BvC,GAAG,CAAC4B,GAAJ,CAAQ,MAAR,CAAgB,IAAG5B,GAAG,CAAC4B,GAAJ,CAAQ,MAAR,CAAgB,MAA3E;AACD,CAFD,E,CAIA;;AACA/B,OAAO,CAAC2C,EAAR,CAAW,oBAAX,EAAkCC,GAAD,IAAS;EACxCH,gBAAOI,KAAP,CAAa,qBAAb,EAAoCD,GAApC;;EAEA,IAAI;IACF/C,MAAM,CAACiD,gBAAP,CAAwBF,GAAxB;EACD,CAFD,CAEE,OAAOA,GAAP,EAAY;IACZH,gBAAOI,KAAP,CAAa,cAAb,EAA6BD,GAA7B;EACD,CAJD,SAIU;IACR5C,OAAO,CAAC+C,IAAR,CAAa,CAAb;EACD;AACF,CAVD,E,CAYA;;AACA/C,OAAO,CAAC2C,EAAR,CAAW,mBAAX,EAAiCC,GAAD,IAAS;EACvCH,gBAAOI,KAAP,CAAa,oBAAb,EAAmCD,GAAnC;;EAEA,IAAI;IACF/C,MAAM,CAACiD,gBAAP,CAAwBF,GAAxB;EACD,CAFD,CAEE,OAAOA,GAAP,EAAY;IACZH,gBAAOI,KAAP,CAAa,cAAb,EAA6BD,GAA7B;EACD,CAJD,SAIU;IACR5C,OAAO,CAAC+C,IAAR,CAAa,CAAb;EACD;AACF,CAVD;AAYAC,OAAO,CAAC7C,GAAR,GAAcR,SAAS,CAACsD,OAAV,CAAkB;EAC9BC,MAAM,EAAE,KADsB;EAE9BC,cAAc,EAAE;AAFc,CAAlB,EAGXC,KAHW,CAGLC,SAHK,CAGKlD,GAHL,CAAd"}